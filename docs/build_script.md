# 构建脚本使用指南 (build.sh)

`build.sh` 是一个功能完整的构建工具，用于自动化构建剪贴板应用的前端和后端。该脚本提供了交互式菜单和命令行参数两种使用方式，可以灵活地适应不同的构建需求。

## 功能概述

- **前端构建**：自动执行 Next.js 项目的构建，并将产物复制到 Go 项目中的指定目录
- **后端构建**：支持交叉编译，可以为不同操作系统（Linux、macOS、Windows）和架构（amd64、arm64、386）构建二进制文件
- **部署包生成**：将二进制文件、运行脚本和配置文件打包成一个压缩文件，方便部署

## 基本用法

```bash
# 确保脚本有执行权限
chmod +x build.sh

# 显示交互式菜单
./build.sh

# 使用默认设置快速构建前后端
./build.sh all

# 只构建前端
./build.sh --frontend

# 只构建后端（指定目标系统为macOS）
./build.sh --backend --os darwin

# 构建前后端（指定端口为3000）
./build.sh --all --port 3000
```

## 参数说明

| 参数 | 长格式 | 说明 |
|------|--------|------|
| `-f` | `--frontend` | 只构建前端 |
| `-b` | `--backend` | 只构建后端 |
| `-a` | `--all` | 构建前端和后端（默认） |
| `-o <os>` | `--os <os>` | 设置目标操作系统（linux, darwin, windows），默认：linux |
| `-r <arch>` | `--arch <arch>` | 设置目标架构（amd64, arm64, 386），默认：amd64 |
| `-n <name>` | `--name <name>` | 设置输出文件名，默认：clipboard |
| `-p <port>` | `--port <port>` | 设置应用程序端口，默认：8080 |
| `-h` | `--help` | 显示帮助信息 |

## 交互式菜单使用

如果直接运行 `./build.sh` 而不带任何参数，脚本将显示交互式菜单：

1. 首先选择构建类型：
   - 只构建前端
   - 只构建后端
   - 构建前端和后端
   - 退出

2. 如果选择构建后端，还需要：
   - 选择目标操作系统（Linux、macOS、Windows）
   - 选择目标架构（amd64、arm64、386）
   - 设置应用端口（默认8080）
   - 确认设置并开始构建

## 构建流程详解

### 前端构建流程

当执行前端构建时，脚本会：

1. 进入 `web` 目录
2. 执行 `npm install` 安装依赖
3. 执行 `npm run build` 构建前端项目
4. 检查 `dist` 目录是否生成
5. 复制 `web/dist/*` 到 `internal/static/dist/` 和 `cmd/web/` 目录

### 后端构建流程

当执行后端构建时，脚本会：

1. 设置交叉编译环境变量（GOOS, GOARCH, CGO_ENABLED=0）
2. 在 `release` 目录中编译 Go 程序
3. 设置可执行权限
4. 复制运行脚本 `run.sh` 到 release 目录，并根据指定端口修改设置
5. 创建部署目录，复制二进制文件和运行脚本
6. 创建包含使用说明的 README.txt
7. 打包成 `.tar.gz` 格式的部署包
8. 清理临时文件

## 输出文件

构建完成后，脚本将在 `release` 目录下生成：

- `clipboard_<os>_<arch>.tar.gz`：部署包，包含可执行文件、运行脚本和说明文档

## 注意事项

1. 确保系统已安装 Go 1.16+ 和 Node.js 16+
2. 确保网络连接正常，以便 npm 能够下载依赖
3. 交叉编译设置 `CGO_ENABLED=0`，确保编译的二进制文件具有更好的兼容性和便携性
4. 在 macOS 上构建时，会设置 `COPYFILE_DISABLE=1` 以防止创建 `.DS_Store` 等元数据文件

## 常见问题

1. **Q: 构建失败，提示找不到 npm 命令**  
   A: 请确保已安装 Node.js 和 npm，可以通过 `node -v` 和 `npm -v` 检查版本

2. **Q: 前端构建后找不到 dist 目录**  
   A: 检查 Next.js 项目的配置，确认构建输出目录设置正确

3. **Q: 交叉编译的二进制文件无法在目标系统运行**  
   A: 确保构建时选择了正确的目标系统和架构，并且目标系统满足程序的依赖要求

4. **Q: Windows 编译的可执行文件没有 .exe 后缀**  
   A: 脚本已考虑这一点，当目标系统为 Windows 时会自动添加 .exe 后缀 