(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{12690:(e,t,a)=>{Promise.resolve().then(a.bind(a,99311))},99311:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>b});var r=a(95155),s=a(12115),i=a(51228),n=a(36505),c=a(3578),l=a(14809);function o(e){let{clipboard:t,onCopy:a,onEdit:i,onRefresh:o,syncEnabled:d=!0,hasPermission:u=!1,onRequestPermission:x}=e,[m,g]=(0,s.useState)(!1),{showToast:f}=(0,l.d)(),h=async()=>{if(t)try{await navigator.clipboard.writeText(t.content),g(!0),a(),setTimeout(()=>{g(!1)},2e3)}catch(e){console.error("复制到剪贴板失败:",e),f("复制失败","error")}};return(0,r.jsxs)("div",{className:"bg-white border-b p-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,r.jsxs)("h2",{className:"text-sm font-medium flex items-center",children:[(0,r.jsx)(n.g,{icon:c.KTq,className:"text-blue-500 mr-2"}),"当前剪贴板"]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[u?d?(0,r.jsxs)("div",{className:"inline-flex items-center px-2 py-1 rounded-full bg-green-50 text-xs text-green-700",children:[(0,r.jsx)(n.g,{icon:c.e68,className:"text-xs mr-1"}),(0,r.jsx)("span",{children:"自动同步已开启"})]}):(0,r.jsxs)("div",{className:"inline-flex items-center px-2 py-1 rounded-full bg-gray-100 text-xs text-gray-600",children:[(0,r.jsx)(n.g,{icon:c.pNp,className:"text-xs mr-1"}),(0,r.jsx)("span",{children:"同步已关闭"})]}):(0,r.jsxs)("button",{onClick:x,className:"inline-flex items-center px-3 py-1.5 rounded-md bg-blue-100 text-xs text-blue-800 hover:bg-blue-200 transition-colors",children:[(0,r.jsx)(n.g,{icon:c.DW4,className:"text-xs mr-1.5"}),(0,r.jsx)("span",{children:"点击授权自动同步"})]}),(0,r.jsx)("button",{className:"text-gray-400 hover:text-gray-600 p-1.5 rounded-full hover:bg-gray-50",onClick:o,children:(0,r.jsx)(n.g,{icon:c.BF2})})]})]}),(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row gap-3",children:[(0,r.jsx)("div",{className:"flex-grow bg-gray-50 rounded-lg p-3 max-h-20 overflow-hidden border border-gray-100",children:u?(0,r.jsx)("p",{className:"text-gray-700 text-sm",children:(null==t?void 0:t.content)||"剪贴板为空，复制任意内容将自动同步到这里..."}):(0,r.jsxs)("p",{className:"text-gray-500 text-sm",children:["需要授权才能自动同步剪贴板内容。授权后，您复制的内容将自动同步到此应用。",(0,r.jsx)("br",{}),(0,r.jsx)("span",{className:"text-xs text-gray-400",children:"请点击上方的“点击授权自动同步”按钮来启用自动同步功能。"})]})}),(0,r.jsxs)("div",{className:"flex sm:flex-col justify-end gap-2 sm:w-auto",children:[(0,r.jsxs)("button",{className:"btn-primary",onClick:h,disabled:!t||!u,children:[(0,r.jsx)(n.g,{icon:c.jPR,className:"mr-1.5"}),m?"已复制":"复制"]}),(0,r.jsxs)("button",{className:"btn-secondary",onClick:i,disabled:!t||!u,children:[(0,r.jsx)(n.g,{icon:c.LFz,className:"mr-1.5"}),"编辑"]})]})]})]})}var d=a(92023);function u(e){let{activeTab:t,onTabChange:a,onFilterClick:s,onSortClick:i}=e;return(0,r.jsxs)("div",{className:"bg-white border-b border-gray-200 px-2 md:px-4 flex items-center justify-between overflow-x-auto scrollbar-none",children:[(0,r.jsxs)("div",{className:"flex flex-nowrap",children:[(0,r.jsx)(x,{label:"全部",isActive:"all"===t,onClick:()=>a("all")}),(0,r.jsx)(x,{label:"文本",isActive:t===d.D.TEXT,onClick:()=>a(d.D.TEXT)}),(0,r.jsx)(x,{label:"链接",isActive:t===d.D.LINK,onClick:()=>a(d.D.LINK)}),(0,r.jsx)(x,{label:"代码",isActive:t===d.D.CODE,onClick:()=>a(d.D.CODE),className:"hidden md:block"}),(0,r.jsx)(x,{label:(0,r.jsxs)("div",{className:"flex items-center whitespace-nowrap",children:[(0,r.jsx)(n.g,{icon:c.DW4,className:"text-gray-600 mr-1.5 text-xs"}),(0,r.jsx)("span",{children:"密码"})]}),isActive:t===d.D.PASSWORD,onClick:()=>a(d.D.PASSWORD)}),(0,r.jsx)(x,{label:(0,r.jsxs)("div",{className:"flex items-center whitespace-nowrap",children:[(0,r.jsx)(n.g,{icon:c.yy,className:"text-amber-500 mr-1.5 text-xs"}),(0,r.jsx)("span",{children:"收藏"})]}),isActive:"favorite"===t,onClick:()=>a("favorite"),className:"hidden md:block"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2 shrink-0",children:[(0,r.jsx)("button",{className:"p-1.5 rounded text-gray-500 hover:bg-gray-50 hover:text-gray-700",onClick:s,children:(0,r.jsx)(n.g,{icon:c.mRM,className:"text-sm"})}),(0,r.jsx)("button",{className:"p-1.5 rounded text-gray-500 hover:bg-gray-50 hover:text-gray-700",onClick:i,children:(0,r.jsx)(n.g,{icon:c.k0E,className:"text-sm"})})]})]})}function x(e){let{label:t,isActive:a,onClick:s,className:i=""}=e;return(0,r.jsx)("button",{className:"px-2 md:px-4 py-3 border-b-2 whitespace-nowrap ".concat(a?"border-blue-500 text-blue-700 font-medium":"border-transparent text-gray-500 hover:text-gray-700"," text-sm ").concat(i),onClick:s,children:t})}var m=a(60136),g=a(26420),f=a(99749);let h=(e,t)=>{if(!e||!t||0===t.length)return!1;let a=e.trim();if(""===a)return!1;for(let e of t)try{if(e.content&&e.content.trim()===a)return!0}catch(e){}if(a.length>100){let e=a.toLowerCase();for(let a of t)try{if(!a.content)continue;let t=a.content.trim().toLowerCase();if(Math.abs(e.length-t.length)/Math.max(e.length,1)<.1&&(e.includes(t)||t.includes(e)))return!0}catch(e){}}return!1};function b(){let[e,t]=(0,s.useState)(),[a,n]=(0,s.useState)([]),[c,x]=(0,s.useState)("all"),[b,y]=(0,s.useState)(!1),[p,v]=(0,s.useState)(),[w,j]=(0,s.useState)(!0),[N,C]=(0,s.useState)(!0),[k,D]=(0,s.useState)(!1),[S,T]=(0,s.useState)(1),[E,A]=(0,s.useState)(1),[F,O]=(0,s.useState)(!1),[G,L]=(0,s.useState)(!1),R=(0,s.useRef)(""),_=(0,s.useRef)(!1),P=(0,s.useRef)(0),I=(0,s.useRef)(!1),M=(0,s.useRef)(!0),H=(0,s.useRef)(0),{showToast:X}=(0,l.d)(),q=(0,s.useCallback)(async()=>{console.log("开始获取剪贴板数据...");try{C(!0),console.log("开始从服务器获取全部数据...");let[e,a]=await Promise.all([f.G.getLatestClipboard(),f.G.getClipboardHistory(1,12)]);if(console.log("最新剪贴板响应:",e),console.log("历史记录响应:",a),e.success&&e.data&&(t(e.data),e.data.content&&(R.current=e.data.content)),a.success&&a.data){let e=[],t=1,r=1;Array.isArray(a.data)?(e=a.data,t=1,r=1):"items"in a.data&&(e=a.data.items,t=a.data.page,r=a.data.totalPages),console.log("获取到 ".concat(e.length," 条历史记录，总页数: ").concat(r)),n(e),T(t),A(r),L(t<r)}_.current=!0}catch(e){console.error("获取所有数据失败:",e),X("获取数据失败","error")}finally{C(!1)}},[X,12]),W=(0,s.useCallback)(async()=>{if(!(S>=E)&&!F)try{let e;O(!0);let t=S+1;if((e="favorite"===c?await f.G.getFavorites(t,12):"all"===c?await f.G.getClipboardHistory(t,12):await f.G.getClipboardHistory(t,12,c)).success&&e.data){let r=new Set(a.map(e=>e.id));if("items"in e.data){let{items:t,page:a,totalPages:s}=e.data,i=t.filter(e=>!r.has(e.id));n(e=>[...e,...i]),T(a),A(s),L(a<s)}else if(Array.isArray(e.data)){let a=e.data.filter(e=>!r.has(e.id));n(e=>[...e,...a]),T(t),L(!1)}}}catch(e){X("加载更多数据失败","error")}finally{O(!1)}},[c,S,E,F,X,a,12]),K=(0,s.useCallback)(async e=>{try{if(!e||""===e.trim())return!1;if(h(e,a))return X("内容已存在于历史记录中","info"),R.current=e,!1;let r=await f.G.saveClipboard({content:e,type:d.D.TEXT});if(!r||!r.success){let e=(null==r?void 0:r.error)||(null==r?void 0:r.message)||"未知错误";return X("保存失败: ".concat(e),"error"),!1}if(R.current=e,r.data){let a=r.data,s={id:a.id||"temp-"+Date.now(),content:a.content||e,type:a.type||d.D.TEXT,title:a.title||"",isFavorite:a.favorite||a.isFavorite||!1,created_at:a.created_at||new Date().toISOString(),createdAt:a.created_at||new Date().toISOString(),updatedAt:a.updated_at||new Date().toISOString()};t(s),n(e=>[s,...e])}else{let a={id:"temp-"+Date.now(),content:e,type:d.D.TEXT,title:"",isFavorite:!1,created_at:new Date().toISOString(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};t(a),n(e=>[a,...e])}return X("新内容已同步","success"),!0}catch(e){return X("保存失败，请重试","error"),!1}},[X,a]),z=(0,s.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=Date.now();if(!(t-H.current<1e3)||e){if(H.current=t,I.current){e&&setTimeout(()=>z(!0),500);return}I.current=!0;try{let e=await navigator.clipboard.readText();if(k||(D(!0),j(!0)),P.current=t,!e||""===e.trim()||e===R.current)return;await K(e)}catch(e){e instanceof DOMException&&"NotAllowedError"===e.name?(D(!1),j(!1),X("无法访问剪贴板，请重新授权","error")):X("读取剪贴板失败","error")}finally{I.current=!1}}},[k,w,X]),B=(0,s.useCallback)(async()=>{try{if(!document.hasFocus())return void X("请先点击页面，然后再请求权限","warning");await navigator.clipboard.readText();let e=await navigator.permissions.query({name:"clipboard-read"});D("granted"===e.state),j("granted"===e.state),"granted"===e.state?(X("剪贴板权限已授予","success"),z(!0)):X("未能获得剪贴板权限","error")}catch(e){D(!1),j(!1),X("无法获取剪贴板权限","error")}},[z,X]),J=(0,s.useCallback)(async()=>{try{let e=await navigator.permissions.query({name:"clipboard-read"}),t="granted"===e.state;if("prompt"===e.state)try{return await navigator.clipboard.readText(),D(!0),j(!0),!0}catch(e){return D(!1),j(!1),!1}return D(t),j(t),e.onchange=()=>{let t="granted"===e.state;D(t),j(t),t&&_.current&&z(!0)},t}catch(e){try{return await navigator.clipboard.readText(),D(!0),j(!0),!0}catch(e){return D(!1),j(!1),!1}}},[z]);(0,s.useEffect)(()=>{let e=!0;(async()=>{try{let t=await navigator.clipboard.readText();console.log("text",t),e&&(D(!0),j(!0))}catch(t){e&&(D(!1),j(!1))}})(),(async()=>{try{if(console.log("开始初始化应用..."),await q(),console.log("数据加载完成，初始化标记:",_.current),!e)return;let t=await J();if(console.log("权限检查结果:",t),!e)return;e&&j(t),t&&e?setTimeout(()=>{e&&_.current&&(H.current=Date.now(),console.log("准备读取剪贴板内容..."),z(!0),M.current=!1)},100):M.current=!1}catch(t){console.error("应用初始化失败:",t),e&&X("应用初始化失败，请刷新页面","error")}})();let t=()=>{if("visible"===document.visibilityState){let t=Date.now();if(t-H.current<1e3)return;let a=async()=>{try{if(!document.hasFocus())return;let a=await navigator.clipboard.readText();e&&(k||(D(!0),j(!0)),H.current=t,a&&a!==R.current&&K(a))}catch(t){t instanceof DOMException&&"NotAllowedError"===t.name||e&&(D(!1),j(!1))}};setTimeout(()=>{e&&_.current&&a()},300)}};document.addEventListener("visibilitychange",t);let a=()=>{if(e&&_.current){let t=Date.now();t-H.current<1e3||setTimeout(()=>{e&&document.hasFocus()&&(H.current=t,z(!1))},300)}};return window.addEventListener("focus",a),()=>{e=!1,document.removeEventListener("visibilitychange",t),window.removeEventListener("focus",a)}},[]),(0,s.useEffect)(()=>{let e=!0;return(async()=>{try{let t;if(C(!0),n([]),T(1),A(1),L(!1),t="favorite"===c?await f.G.getFavorites(1,12):"all"===c?await f.G.getClipboardHistory(1,12):await f.G.getClipboardHistory(1,12,c),!e)return;if(t.success&&t.data)if("items"in t.data){let{items:e,page:a,totalPages:r}=t.data;n(e),T(a),A(r),L(a<r)}else Array.isArray(t.data)&&(n(t.data),T(1),L(!1));else X(t.message||"加载数据失败","error")}catch(t){e&&X("加载数据失败","error")}finally{e&&C(!1)}})(),()=>{e=!1}},[c,X,12]);let Q=(0,s.useCallback)(e=>{e&&navigator.clipboard.writeText(e.content).then(()=>X("已复制到剪贴板","success")).catch(e=>{X("复制失败","error")})},[X]),U=(0,s.useCallback)(e=>{v(e),y(!0)},[]),V=(0,s.useCallback)(async a=>{try{let r=await f.G.deleteClipboard(a.id);if(r.success){if(n(e=>e.filter(e=>e.id!==a.id)),e&&e.id===a.id){let e=await f.G.getLatestClipboard();e.success&&e.data?t(e.data):t(void 0)}X("删除成功","success")}else X(r.message||"删除失败","error")}catch(e){X("删除失败","error")}},[e,X]),Y=(0,s.useCallback)(async a=>{try{let r=await f.G.toggleFavorite(a.id,!a.isFavorite);r.success&&r.data?(n(e=>e.map(e=>e.id===a.id?{...e,isFavorite:!e.isFavorite}:e)),e&&e.id===a.id&&t({...e,isFavorite:!e.isFavorite}),X(a.isFavorite?"已取消收藏":"已添加到收藏","success")):X(r.message||"操作失败","error")}catch(e){X("操作失败","error")}},[e,X]),Z=(0,s.useCallback)(async a=>{if(p)try{let r=await f.G.updateClipboard(p.id,a);r.success&&r.data?(n(e=>e.map(e=>e.id===p.id?r.data:e)),e&&e.id===p.id&&t(r.data),X("更新成功","success")):X(r.message||"更新失败","error")}catch(e){throw console.error("更新失败:",e),X("更新失败","error"),e}},[e,p,X]),$=(0,s.useCallback)(async()=>{await q(),X("数据已刷新","success")},[q,X]);return(0,r.jsxs)(i.A,{children:[(0,r.jsx)(o,{clipboard:e,onCopy:()=>Q(e),onEdit:()=>U(e),onRefresh:$,syncEnabled:w,hasPermission:k,onRequestPermission:B}),(0,r.jsx)(u,{activeTab:c,onTabChange:x,onFilterClick:()=>console.log("打开过滤器"),onSortClick:()=>console.log("打开排序")}),(0,r.jsx)("div",{className:"flex-1 overflow-hidden",children:(0,r.jsx)("div",{className:"h-full overflow-y-auto custom-scrollbar p-4",children:N?(0,r.jsx)("div",{className:"flex justify-center items-center h-40",children:(0,r.jsx)("span",{className:"text-gray-400",children:"加载中..."})}):(0,r.jsx)(m.A,{items:a,onCopy:Q,onEdit:U,onDelete:V,onToggleFavorite:Y,hasMore:G,onLoadMore:W,isLoadingMore:F})})}),(0,r.jsx)(g.A,{isOpen:b,onClose:()=>{y(!1),v(void 0)},onSave:Z,initialData:p})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[266,181,220,908,608,441,684,358],()=>t(12690)),_N_E=e.O()}]);